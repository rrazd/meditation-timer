---
phase: 02-session-controls-and-platform-resilience
plan: "02"
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - src/utils/wake-lock.ts
  - src/main.ts
  - index.html
  - src/styles/variables.css
autonomous: true
requirements:
  - UX-05
  - UX-06

must_haves:
  truths:
    - "Device screen does not dim or lock while a session is actively counting down"
    - "Wake lock is re-acquired when the user returns to the tab after switching away (active session, not paused)"
    - "Wake lock is NOT re-acquired when the user returns to a paused session"
    - "Wake lock is released when the session ends (stop or complete)"
    - "App layout does not overflow on iOS Safari (no vertical scrollbar on a single-screen layout)"
    - "Pause and End Session buttons are at least 44px tall on touch devices"
    - "Tapping buttons on mobile has no perceptible 300ms delay"
  artifacts:
    - path: "src/utils/wake-lock.ts"
      provides: "acquireWakeLock and releaseWakeLock functions"
      exports: ["acquireWakeLock", "releaseWakeLock"]
    - path: "src/main.ts"
      provides: "Wake lock lifecycle wiring (acquire on start, release on stop/complete, re-acquire on visibility)"
      contains: "visibilitychange"
    - path: "index.html"
      provides: "viewport-fit=cover in meta viewport tag"
      contains: "viewport-fit=cover"
    - path: "src/styles/variables.css"
      provides: "100dvh, safe-area insets, touch-action: manipulation, 44px touch targets"
      contains: "100dvh"
  key_links:
    - from: "src/main.ts"
      to: "src/utils/wake-lock.ts"
      via: "acquireWakeLock() called in initSetupScreen callback and session:resume handler; releaseWakeLock() called in stop callback and session:complete handler"
      pattern: "acquireWakeLock|releaseWakeLock"
    - from: "src/main.ts"
      to: "src/state.ts"
      via: "visibilitychange handler checks state.sessionActive && !state.sessionPaused before re-acquiring"
      pattern: "sessionActive.*sessionPaused|sessionPaused.*sessionActive"
---

<objective>
Add Screen Wake Lock support and mobile usability fixes. Creates src/utils/wake-lock.ts as a self-contained module, wires it into the existing main.ts session lifecycle handlers, and updates index.html + variables.css with mobile viewport and touch target improvements.

Purpose: Deliver UX-05 (screen stays awake during active sessions) and UX-06 (app is fully usable on mobile browsers). These are platform resilience features that make the product usable on the devices where meditation timers are most commonly used.

Output: Working wake lock with correct acquire/release/re-acquire lifecycle; mobile layout that does not overflow on iOS Safari; 44px touch targets on touch devices with no tap delay.
</objective>

<execution_context>
@/Users/rrazdan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rrazdan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-session-controls-and-platform-resilience/02-01-SUMMARY.md
@src/main.ts
@src/state.ts
@src/styles/variables.css
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create wake-lock.ts and wire lifecycle into main.ts</name>
  <files>src/utils/wake-lock.ts, src/main.ts</files>
  <action>
    Create src/utils/wake-lock.ts as a new file with these exact exports:

    ```typescript
    // src/utils/wake-lock.ts
    // Screen Wake Lock API — MDN: https://developer.mozilla.org/en-US/docs/Web/API/Screen_Wake_Lock_API
    // WakeLockSentinel cannot be reused after release. Always call navigator.wakeLock.request() for a new one.
    // The 'release' event fires on both manual release and browser auto-release (tab hidden, low battery).

    let wakeLock: WakeLockSentinel | null = null;

    export async function acquireWakeLock(): Promise<void> {
      if (!('wakeLock' in navigator)) return; // Unsupported — degrade silently; timer still works
      if (wakeLock !== null) return; // Already held — no-op (null-check is safer than .released cross-browser)
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => {
          // Fires on both manual release and browser auto-release (tab hidden, low battery).
          // Clear reference so next acquireWakeLock() call requests a fresh sentinel.
          wakeLock = null;
        });
      } catch (err) {
        // NotAllowedError: low battery, power-save mode, or browser policy — non-fatal.
        // Session continues without wake lock.
        console.warn('[WakeLock] Request refused:', (err as Error).message);
        wakeLock = null;
      }
    }

    export async function releaseWakeLock(): Promise<void> {
      if (wakeLock !== null) {
        try {
          await wakeLock.release();
        } catch {
          // Sentinel may have already been auto-released — safe to ignore.
        }
        wakeLock = null;
      }
    }
    ```

    In src/main.ts, make these targeted additions (all existing code from Plan 02-01 is preserved):

    1. Add import at the top of the file:
       ```typescript
       import { acquireWakeLock, releaseWakeLock } from './utils/wake-lock.js';
       ```

    2. In the `initSetupScreen` callback, add `await acquireWakeLock()` after `timer.start(durationMs)`. The callback must become `async`:
       ```typescript
       initSetupScreen(async (durationMs: number) => {
         state.sessionDurationMs = durationMs;
         state.sessionActive = true;
         state.sessionPaused = false;
         timer.start(durationMs);
         await acquireWakeLock();
         transitionToSession();
       });
       ```

    3. In the `initSessionScreen` stop callback, add `await releaseWakeLock()` after `timer.stop()`. The callback must become `async`:
       ```typescript
       const { reset: resetSessionScreen } = initSessionScreen(async () => {
         state.sessionActive = false;
         state.sessionPaused = false;
         timer.stop();
         await releaseWakeLock();
         resetSessionScreen();
         transitionToSetup();
       });
       ```

    4. In the `session:resume` bus handler (added in Plan 02-01), add `await acquireWakeLock()`. The listener callback must become `async`:
       ```typescript
       bus.on('session:resume', async () => {
         timer.resume();
         state.sessionPaused = false;
         await acquireWakeLock(); // Re-acquire: may have been released during paused tab-switch
       });
       ```

    5. In the `session:complete` bus handler (updated in Plan 02-01), add `await releaseWakeLock()`. The listener callback must become `async`:
       ```typescript
       bus.on('session:complete', async () => {
         if (!state.sessionActive) return;
         state.sessionActive = false;
         state.sessionPaused = false;
         await releaseWakeLock();
         resetSessionScreen();
         // Phase 3 will call playChime() here
         transitionToSetup();
       });
       ```

    6. Register a `visibilitychange` listener once at the bottom of main.ts (after all other wiring). Register it unconditionally at startup — do NOT add/remove it per session:
       ```typescript
       // Re-acquire wake lock when returning to an active, non-paused session.
       // Registered once at startup. The browser auto-releases the sentinel when a tab is hidden.
       document.addEventListener('visibilitychange', async () => {
         if (
           document.visibilityState === 'visible' &&
           state.sessionActive &&
           !state.sessionPaused
         ) {
           await acquireWakeLock();
         }
       });
       ```
  </action>
  <verify>
    Run `npx tsc --noEmit` — zero errors. Run `npm run dev`. Start a session and open DevTools -> Application tab -> Background services -> Wake Lock. Confirm "Wake Lock acquired" appears. Stop the session and confirm the wake lock is released. Switch to another browser tab during an active session, return — wake lock should reappear in DevTools. Pause the session, switch tabs, return — wake lock should NOT be re-acquired (timer is frozen).
  </verify>
  <done>
    src/utils/wake-lock.ts exists and exports acquireWakeLock/releaseWakeLock. Wake lock is acquired on session start, released on stop and complete, re-acquired on tab return (only when not paused). TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mobile viewport, safe-area insets, touch targets, and dvh layout</name>
  <files>index.html, src/styles/variables.css</files>
  <action>
    In index.html:

    1. Replace the existing viewport meta tag:
       ```html
       <!-- BEFORE -->
       <meta name="viewport" content="width=device-width, initial-scale=1.0" />
       <!-- AFTER -->
       <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
       ```
       NOTE: Do NOT add `user-scalable=no` — it violates WCAG SC 1.4.4 (Resize Text) and must never be used.

    2. In the `#setup-screen` div, change `min-height: 100vh` to `min-height: 100dvh`.
    3. In the `#session-screen` div, change `min-height: 100vh` to `min-height: 100dvh`.
       Reason: `100dvh` (Dynamic Viewport Height) is Baseline Widely Available since 2023. On mobile Safari, `100vh` equals the maximum viewport height (browser chrome retracted), causing overflow when the address bar is visible. `100dvh` adjusts dynamically.

    In src/styles/variables.css, append the following rules after the existing `:root` block and `prefers-reduced-motion` block:

    ```css
    /* ------------------------------------------------------------------ */
    /* Mobile: safe-area insets (notch / Dynamic Island / home indicator)  */
    /* Requires viewport-fit=cover in the meta viewport tag.               */
    /* ------------------------------------------------------------------ */
    #setup-screen,
    #session-screen {
      padding-top: env(safe-area-inset-top, 0px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
      padding-left: env(safe-area-inset-left, 0px);
      padding-right: env(safe-area-inset-right, 0px);
      box-sizing: border-box;
    }

    /* ------------------------------------------------------------------ */
    /* Touch: remove 300ms tap delay on all interactive elements           */
    /* touch-action: manipulation preserves scroll and pinch-zoom.         */
    /* Do NOT use touch-action: none (breaks scrolling).                   */
    /* ------------------------------------------------------------------ */
    button,
    input,
    a {
      touch-action: manipulation;
    }

    /* ------------------------------------------------------------------ */
    /* Touch: minimum 44px touch targets on touchscreen devices            */
    /* Use pointer: coarse (not hover: none) — covers hybrid devices too.  */
    /* ------------------------------------------------------------------ */
    @media (pointer: coarse) {
      button {
        min-height: 44px;
        min-width: 44px;
      }
      input[type="number"] {
        min-height: 44px;
      }
    }
    ```

    Do NOT add `@media (pointer: coarse)` rules that conflict with the existing inline styles on `#pause-button` and `#stop-button` (those already have `min-height: 44px` set inline from Plan 02-01). The global `button` rule in the media query is sufficient and consistent.
  </action>
  <verify>
    Run `npx tsc --noEmit` — zero errors. Run `npm run build` — dist/ produced, no errors. Open in Chrome DevTools Device Toolbar (iPhone 14 profile). Confirm:
    - No vertical scrollbar on setup screen or session screen
    - Both screens fill the viewport without overflow
    - In DevTools Computed Styles for #setup-screen, min-height resolves to a dvh value
    Confirm `viewport-fit=cover` is in the meta tag by inspecting the HTML source.
  </verify>
  <done>
    index.html uses `min-height: 100dvh` on both screens and `viewport-fit=cover` in the viewport meta tag. variables.css adds safe-area insets, touch-action: manipulation on interactive elements, and 44px minimum touch targets under `@media (pointer: coarse)`. TypeScript compiles and builds without errors.
  </done>
</task>

</tasks>

<verification>
Full plan verification after both tasks:
1. `npx tsc --noEmit` — must exit 0
2. `npm run build` — must produce dist/ with no errors
3. Wake lock lifecycle (requires HTTPS or localhost):
   - Active session: DevTools Application -> Wake Lock shows active
   - End Session: Wake Lock released
   - Switch tabs during active session, return: Wake Lock re-acquired
   - Pause session, switch tabs, return: Wake Lock NOT re-acquired
4. Mobile layout (Chrome DevTools Device Toolbar):
   - iPhone 14 profile: no overflow, no scrollbar on either screen
   - Buttons visible and not obscured by viewport bottom
5. Confirm no `user-scalable=no` in viewport meta tag
</verification>

<success_criteria>
- UX-05: Screen wake lock acquired on session start, released on stop/complete, re-acquired on tab return when active and not paused
- UX-06: App renders correctly on mobile (100dvh, safe-area insets, viewport-fit=cover), all buttons meet 44px touch target minimum, taps are instant (touch-action: manipulation)
- TypeScript compiles and builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-controls-and-platform-resilience/02-02-SUMMARY.md` following the summary template.
</output>
